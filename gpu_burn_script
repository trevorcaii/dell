import subprocess
from datetime import datetime
import time

def execute_shell_command(command):
    try:
        # Execute the shell command
        result = subprocess.run(command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        if result.returncode == 0:
            # Successful execution
            return result.stdout.decode("utf-8").strip()  # Decode bytes to string
        else:
            # Error occurredhttps://github.com/manunicholasjacob/Testing/blob/main/getbdf2
            return f"Error: {result.stderr.decode('utf-8').strip()}"  # Decode bytes to string
    except Exception as e:
        return f"Error: {str(e)}"


def check_replay(gpu_percentage = 95, burn_time = 3600, gpu_number = 0, gpu_index = -1, call_time = 0.5):
    try:
        print("Starting gpu_burn...")
        # "> /dev/null" will not clutter stdout with gpu_burn's outputs
        gpu_process = subprocess.Popen(['./gpu_burn', '>', '/dev/null'], stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        print("running in background")
    except Exception as e:
        return f"Error: {str(e)}"

    # Periodically execute another command while './gpu_burn' is running
    replay_count = ""
    while gpu_process.poll() is None:
        if(gpu_index != -1):
            now = datetime.now()
            print("Current Timestamp:", now)
            print(f"GPU {gpu_index}:")
            replay_count = execute_shell_command(f"nvidia-smi -i {gpu_index} -q|grep -i replay")
            replay_count = replay_count.split("\n")
            for line in replay_count: print(line.strip())
            print()
            time.sleep(call_time) 
        else:
            now = datetime.now()
            print("Current Timestamp:", now)
            for i in range(gpu_number):
                print(f"GPU {i}:")
                replay_count = execute_shell_command(f"nvidia-smi -i {i} -q|grep -i replay")
                replay_count = replay_count.split("\n")
                for line in replay_count: print(line.strip())
            print()
            time.sleep(call_time) 

    # 'gpu_burn' has finished; you can perform any cleanup or final actions here
    print("gpu_burn has completed.")
    bdf_read = execute_shell_command("nvidia-smi --query-gpu=pci.bus_id --format=csv,noheader")
    bdf_read = bdf_read.split('\n')
    bdf_read = [":".join(line.split(':')[1:]) for line in bdf_read]
    with open("output.txt","w") as file:
        for gpu_index_tag, bdf in enumerate(bdf_read): file.write(f"GPU {gpu_index_tag}: " + bdf + "\n")
        for line in replay_count: file.write(line.strip())

def main():
    check_replay(gpu_number=4)

if __name__ == "__main__":
    main()
